<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Browser Console Monitor - DOCX Upload Errors</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #161b22;
            border-radius: 8px;
        }
        .test-section {
            background: #161b22;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        .console {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        .error { color: #ff7b72; }
        .warn { color: #d29922; }
        .info { color: #58a6ff; }
        .success { color: #3fb950; }
        .network { color: #a5a5a5; }
        .timestamp {
            color: #8b949e;
            font-size: 10px;
        }
        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status.error { background: #ff7b72; }
        .status.warn { background: #d29922; }
        .status.info { background: #58a6ff; }
        .status.success { background: #3fb950; }
        .status.network { background: #a5a5a5; }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
        }
        button:hover { background: #2ea043; }
        button:disabled { background: #484f58; cursor: not-allowed; }
        button.warn { background: #d29922; }
        button.warn:hover { background: #bb8009; }
        .upload-area {
            border: 2px dashed #30363d;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }
        .upload-area:hover { border-color: #58a6ff; }
        .upload-area.dragover { border-color: #3fb950; background: #0d1117; }
        .error-summary {
            background: #1c2128;
            border-left: 4px solid #ff7b72;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success-summary {
            background: #1c2128;
            border-left: 4px solid #3fb950;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .network-info {
            background: #1c2128;
            border-left: 4px solid #58a6ff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Real-Time Browser Console Monitor</h1>
            <h2>DOCX Upload JavaScript Error Investigation</h2>
            <p>Monitoring: Flutter Web (http://localhost:3000) ‚Üí API (http://localhost:8000)</p>
        </div>

        <div class="test-section">
            <h3>1. Pre-flight CORS Test</h3>
            <button onclick="testCORSPreflight()">Test CORS Preflight Request</button>
            <div id="cors-results"></div>
        </div>

        <div class="test-section">
            <h3>2. DOCX File Upload Test</h3>
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <p>Click to select DOCX file or drag & drop here</p>
                <input type="file" id="file-input" accept=".docx" style="display: none;" />
            </div>
            <button onclick="testDocxUpload()">Test DOCX Upload</button>
            <div id="upload-results"></div>
        </div>

        <div class="test-section">
            <h3>3. Network Monitoring</h3>
            <button onclick="startNetworkMonitoring()">Start Network Monitoring</button>
            <button onclick="stopNetworkMonitoring()">Stop Network Monitoring</button>
            <div id="network-results"></div>
        </div>

        <div class="test-section">
            <h3>4. Real-Time Console Output</h3>
            <button onclick="clearConsole()">Clear Console</button>
            <button onclick="exportLogs()">Export Logs</button>
            <div class="console" id="console"></div>
        </div>

        <div class="test-section">
            <h3>5. Error Summary & Analysis</h3>
            <div id="error-summary"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const FLUTTER_BASE = 'http://localhost:3000';
        let consoleLogs = [];
        let networkMonitoring = false;
        let networkRequests = [];

        // Enhanced console capture with timestamps
        function addLog(level, message, type = 'info', data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                level,
                message,
                timestamp,
                type,
                data
            };
            consoleLogs.push(logEntry);

            const consoleDiv = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `${level} ${type}`;
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'timestamp';
            timeSpan.textContent = `[${new Date().toLocaleTimeString()}] `;
            
            const statusSpan = document.createElement('span');
            statusSpan.className = `status ${level}`;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = `${message}`;
            
            line.appendChild(timeSpan);
            line.appendChild(statusSpan);
            line.appendChild(messageSpan);
            
            if (data) {
                const dataSpan = document.createElement('pre');
                dataSpan.style.marginTop = '5px';
                dataSpan.style.fontSize = '10px';
                dataSpan.textContent = JSON.stringify(data, null, 2);
                line.appendChild(dataSpan);
            }
            
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Override native console methods
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            addLog('info', args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            addLog('error', args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            addLog('warn', args.join(' '), 'warn');
        };

        // File upload handling
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        let selectedFile = null;

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                selectedFile = e.target.files[0];
                uploadArea.innerHTML = `<p>Selected: ${selectedFile.name} (${selectedFile.size} bytes)</p>`;
                addLog('info', `File selected: ${selectedFile.name}`, 'info');
            }
        });

        // Drag and drop handling
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files[0] && files[0].name.endsWith('.docx')) {
                selectedFile = files[0];
                uploadArea.innerHTML = `<p>Selected: ${selectedFile.name} (${selectedFile.size} bytes)</p>`;
                addLog('info', `File selected via drag & drop: ${selectedFile.name}`, 'info');
            } else {
                addLog('error', 'Please select a valid DOCX file', 'error');
            }
        });

        // CORS Preflight Test
        async function testCORSPreflight() {
            addLog('info', 'Testing CORS preflight request...', 'network');
            
            try {
                const response = await fetch(`${API_BASE}/documents/upload`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type,authorization'
                    }
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };

                let results = '<div class="network-info"><h4>‚ö†Ô∏è CORS PREFLIGHT RESULTS:</h4>';
                results += `<p>Status: ${response.status} ${response.statusText}</p>`;
                
                let hasErrors = false;
                for (const [header, value] of Object.entries(corsHeaders)) {
                    if (value) {
                        results += `<p style="color: #3fb950;">‚úÖ ${header}: ${value}</p>`;
                    } else {
                        results += `<p style="color: #ff7b72;">‚ùå ${header}: Missing</p>`;
                        hasErrors = true;
                    }
                }

                if (hasErrors) {
                    results += '<div class="error-summary"><strong>üö® JAVASCRIPT ERROR RISK:</strong><br>Missing CORS headers will cause browser to block requests with CORS policy errors.</div>';
                } else {
                    results += '<div class="success-summary">‚úÖ CORS configuration appears correct</div>';
                }

                results += '</div>';
                document.getElementById('cors-results').innerHTML = results;
                
                addLog(hasErrors ? 'error' : 'success', 
                    `CORS preflight ${hasErrors ? 'failed' : 'passed'} - Status: ${response.status}`, 
                    hasErrors ? 'error' : 'success');

            } catch (error) {
                addLog('error', `CORS preflight failed: ${error.message}`, 'error');
                document.getElementById('cors-results').innerHTML = 
                    `<div class="error-summary">‚ùå CORS preflight failed: ${error.message}</div>`;
            }
        }

        // DOCX Upload Test
        async function testDocxUpload() {
            if (!selectedFile) {
                addLog('error', 'No file selected for upload', 'error');
                return;
            }

            addLog('info', `Starting DOCX upload test for ${selectedFile.name}`, 'network');
            const startTime = Date.now();

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('filename', selectedFile.name);
                formData.append('document_type', 'script');

                addLog('info', 'Making POST request to upload endpoint...', 'network');

                const response = await fetch(`${API_BASE}/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const responseTime = Date.now() - startTime;
                const responseText = await response.text();

                addLog('network', `Response: ${response.status} ${response.statusText} (${responseTime}ms)`, 'network');

                let results = '<div class="test-results">';
                results += '<div>';
                results += `<h4>Response Details:</h4>`;
                results += `<p>Status: ${response.status} ${response.statusText}</p>`;
                results += `<p>Response Time: ${responseTime}ms</p>`;
                results += `<p>Content-Type: ${response.headers.get('content-type')}</p>`;
                results += '</div>';

                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(responseText);
                        results += '<div class="success-summary">';
                        results += `<h4>‚úÖ Upload Successful</h4>`;
                        results += `<p>Document ID: ${jsonData.document_id || 'N/A'}</p>`;
                        results += `<p>Status: ${jsonData.status || 'N/A'}</p>`;
                        results += '</div>';
                        addLog('success', 'DOCX upload successful', 'success');
                    } catch (parseError) {
                        results += '<div class="error-summary">';
                        results += '<h4>‚ùå JSON Parse Error</h4>';
                        results += `<p>Error: ${parseError.message}</p>`;
                        results += `<p>Raw response: ${responseText}</p>`;
                        results += '</div>';
                        addLog('error', `JSON parsing failed: ${parseError.message}`, 'error');
                    }
                } else {
                    results += '<div class="error-summary">';
                    results += '<h4>‚ùå Upload Failed</h4>';
                    try {
                        const errorData = JSON.parse(responseText);
                        results += `<p>Error: ${errorData.detail?.message || 'Unknown error'}</p>`;
                    } catch (parseError) {
                        results += `<p>Response not JSON: ${responseText}</p>`;
                    }
                    results += '</div>';
                    addLog('error', `Upload failed: ${response.status}`, 'error');
                }

                results += '</div>';
                document.getElementById('upload-results').innerHTML = results;

            } catch (error) {
                addLog('error', `Upload test failed: ${error.message}`, 'error');
                document.getElementById('upload-results').innerHTML = 
                    `<div class="error-summary">‚ùå Upload failed: ${error.message}</div>`;
            }
        }

        // Network monitoring
        function startNetworkMonitoring() {
            networkMonitoring = true;
            networkRequests = [];
            addLog('info', 'Started network monitoring', 'network');
            
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                if (networkMonitoring) {
                    const start = Date.now();
                    return originalFetch.apply(this, args)
                        .then(response => {
                            const duration = Date.now() - start;
                            const request = {
                                url: args[0],
                                method: args[1]?.method || 'GET',
                                status: response.status,
                                duration: duration,
                                timestamp: new Date().toISOString()
                            };
                            networkRequests.push(request);
                            addLog('network', `Network: ${request.method} ${request.url} -> ${request.status} (${request.duration}ms)`, 'network');
                            return response;
                        })
                        .catch(error => {
                            const duration = Date.now() - start;
                            addLog('error', `Network error: ${error.message} (${duration}ms)`, 'error');
                            throw error;
                        });
                }
                return originalFetch.apply(this, args);
            };
        }

        function stopNetworkMonitoring() {
            networkMonitoring = false;
            addLog('info', 'Stopped network monitoring', 'network');
        }

        // Utility functions
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            consoleLogs = [];
            addLog('info', 'Console cleared', 'info');
        }

        function exportLogs() {
            const data = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                consoleLogs: consoleLogs,
                networkRequests: networkRequests
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `browser-console-logs-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('info', 'Logs exported to JSON file', 'info');
        }

        // Error tracking
        window.addEventListener('error', (event) => {
            addLog('error', `Uncaught error: ${event.error?.message || event.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            addLog('error', `Unhandled promise rejection: ${event.reason}`, 'error');
        });

        // Initialize
        window.addEventListener('load', () => {
            addLog('info', 'Real-time console monitor initialized', 'info');
            addLog('info', `Monitoring requests to: ${API_BASE}`, 'info');
            addLog('info', `Flutter Web running at: ${FLUTTER_BASE}`, 'info');
            
            // Auto-test CORS
            setTimeout(testCORSPreflight, 1000);
        });
    </script>
</body>
</html>